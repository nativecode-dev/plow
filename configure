#!/bin/bash

#-------------------------------------------------------------------------------
# Environment Variables
#-------------------------------------------------------------------------------
export ENVIRONMENT=${1:-production}
export ENVIRONMENT_ACTION=${2:-help}

export BASH=`which bash`
export HOME=`eval "echo ~/"`
export SHELL=$(echo $SHELL)

export AWS_IAM_AUTH=`which aws-iam-authenticator`
export AWS_HEPTIO_AUTH=`which heptio-authenticator-aws`

URL_IAM_AUTH=https://amazon-eks.s3-us-west-2.amazonaws.com/1.12.7/2019-03-27/bin/linux/amd64/aws-iam-authenticator
URL_HEPTIO_AUTH=https://github.com/kubernetes-sigs/aws-iam-authenticator/releases/download/v0.3.0/heptio-authenticator-aws_0.3.0_linux_amd64

#-------------------------------------------------------------------------------
# Show Help
#-------------------------------------------------------------------------------
if [ "${ENVIRONMENT_ACTION}" = "help" ]; then
    echo "ENVIRONMENT: ${ENVIRONMENT}"
    echo "ENVIRONMENT_ACTION: ${ENVIRONMENT_ACTION}"
    exit
fi


#-------------------------------------------------------------------------------
# Ensure Kubernetes Profile Folder
#-------------------------------------------------------------------------------
if [ ! -h "${HOME}/.kube" ]; then
    echo "Profile symlink does not exist"
    ln -s ${HOME}/snap/eksctl/current ${HOME}/.kube
fi


#-------------------------------------------------------------------------------
# Ensure user bin
#-------------------------------------------------------------------------------
if [ ! -d "${HOME}/bin" ]; then
    mkdir -p $HOME/bin
fi


#-------------------------------------------------------------------------------
# Ensure auth binaries
#-------------------------------------------------------------------------------
if [ "${AWS_IAM_AUTH}" = "" ] || [ ! -f "${AWS_IAM_AUTH}" ]; then
    curl -sS -o $HOME/bin/aws-iam-authenticator ${URL_IAM_AUTH} > /dev/null
    chmod +x $HOME/bin/aws-iam-authenticator
fi

if [ "${AWS_HEPTIO_AUTH}" = "" ] || [ ! -f "${AWS_HEPTIO_AUTH}" ]; then
    curl -sS -o $HOME/bin/heptio-authenticator-aws ${URL_HEPTIO_AUTH} > /dev/null
    chmod +x $HOME/bin/heptio-authenticator-aws
fi


#-------------------------------------------------------------------------------
# Configure GitLab
#-------------------------------------------------------------------------------
$BASH ./env-gitlab.sh
